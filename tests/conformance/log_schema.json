{
  "schema_version": 2,
  "description": "Canonical structured log schema for frankenlibc unit/conformance/e2e/perf/release workflows. All log lines must be JSONL (one JSON object per line) conforming to this schema.",
  "compatibility_policy": {
    "principle": "Backwards-compatible by default",
    "rules": [
      "New optional fields may be added within schema_version=2 without breaking existing emitters/consumers.",
      "Required fields must not change without a schema_version bump.",
      "Enum vocabularies should only expand (never rename) within a schema_version.",
      "Emitters may add extra fields not listed here inside `details` (preferred) or as top-level fields during migrations; validators should be tolerant unless a gate explicitly opts into strictness."
    ]
  },
  "emitter_checklist": [
    "Emit one JSON object per line (JSONL), no trailing commas.",
    "Always include: timestamp, trace_id, level, event.",
    "trace_id must be stable for the run and follow <bead_id>::<run_id>::<seq>.",
    "Prefer setting bead_id explicitly even though it can be derived from trace_id.",
    "Set stream and gate for joinable aggregation across workflows.",
    "When applicable, set mode (strict|hardened), api_family, and symbol.",
    "On membrane-related events, set decision and profile; on repairs set healing_action.",
    "If decision is set, always include controller_id, decision_action, and risk_inputs object.",
    "On failures, set outcome=fail and include artifact_refs pointing to diffs/backtraces/reports.",
    "Put large/variable payloads in details (object) rather than inventing many ad-hoc top-level keys."
  ],
  "required_fields": {
    "timestamp": {
      "type": "string",
      "format": "ISO-8601 UTC (e.g., 2026-02-11T06:00:00.000Z)",
      "description": "When the event occurred"
    },
    "trace_id": {
      "type": "string",
      "format": "<bead_id>::<run_id>::<seq> (e.g., bd-144::run-abc123::001)",
      "description": "Correlation ID linking log entries across a single test/e2e run"
    },
    "level": {
      "type": "string",
      "enum": ["trace", "debug", "info", "warn", "error", "fatal"],
      "description": "Log severity level"
    },
    "event": {
      "type": "string",
      "description": "Machine-readable event name (e.g., test_start, validation_pass, abi_call)"
    }
  },
  "optional_fields": {
    "bead_id": {
      "type": "string",
      "description": "Bead that owns this test/verification run"
    },
    "stream": {
      "type": "string",
      "enum": ["unit", "conformance", "e2e", "perf", "release"],
      "description": "Evidence stream / workflow domain"
    },
    "gate": {
      "type": "string",
      "description": "Pipeline step / gate name (e.g., ci, e2e_suite, perf_gate, closure_gate)"
    },
    "mode": {
      "type": "string",
      "enum": ["strict", "hardened"],
      "description": "TSM runtime mode under test"
    },
    "api_family": {
      "type": "string",
      "description": "API family (e.g., malloc, string, stdio, pthread, signal)"
    },
    "symbol": {
      "type": "string",
      "description": "Specific ABI symbol being tested (e.g., memcpy, malloc, strlen)"
    },
    "span_id": {
      "type": "string",
      "description": "Optional span id for multi-component traces under one trace_id"
    },
    "parent_span_id": {
      "type": "string",
      "description": "Optional parent span id"
    },
    "profile": {
      "type": "string",
      "enum": ["Fast", "Full"],
      "description": "Membrane validation profile selected by runtime policy"
    },
    "healing_action": {
      "type": "string",
      "description": "Healing action applied (hardened mode) when applicable"
    },
    "controller_id": {
      "type": "string",
      "description": "Runtime controller identity responsible for decision routing"
    },
    "decision_action": {
      "type": "string",
      "enum": ["Allow", "FullValidate", "Repair", "Deny"],
      "description": "Explainability action label emitted by decision controller"
    },
    "risk_inputs": {
      "type": "object",
      "description": "Explainability risk/context inputs used to select decision action"
    },
    "decision": {
      "type": "string",
      "enum": ["Allow", "FullValidate", "Repair", "Deny"],
      "description": "TSM pipeline decision (for membrane-related events)"
    },
    "outcome": {
      "type": "string",
      "enum": ["pass", "fail", "skip", "error", "timeout"],
      "description": "Test case or verification outcome"
    },
    "errno": {
      "type": "integer",
      "description": "errno value observed (0 = success)"
    },
    "exit_code": {
      "type": "integer",
      "description": "Exit code for external processes/scripts when relevant"
    },
    "latency_ns": {
      "type": "integer",
      "description": "Operation latency in nanoseconds"
    },
    "duration_ms": {
      "type": "integer",
      "description": "Wall-clock duration for a higher-level gate step (milliseconds)"
    },
    "artifact_refs": {
      "type": "array",
      "items": "string",
      "description": "Paths to related artifacts (snapshots, diffs, backtraces)"
    },
    "details": {
      "type": "object",
      "description": "Free-form additional context (test inputs, expected vs actual, etc.)"
    }
  },
  "artifact_index_schema": {
    "description": "Format for artifact index files linking logs to verification artifacts",
    "required_fields": {
      "index_version": {
        "type": "integer",
        "description": "Schema version (currently 1)"
      },
      "run_id": {
        "type": "string",
        "description": "Unique run identifier matching trace_id run component"
      },
      "bead_id": {
        "type": "string",
        "description": "Bead owning this run"
      },
      "generated_utc": {
        "type": "string",
        "description": "When this index was generated"
      },
      "artifacts": {
        "type": "array",
        "items": {
          "type": "object",
          "required": ["path", "kind", "sha256"],
          "properties": {
            "path": "Relative path to artifact",
            "kind": "log | snapshot | golden | diff | backtrace | report",
            "sha256": "SHA-256 hex digest for integrity verification",
            "size_bytes": "File size",
            "description": "What this artifact contains"
          }
        }
      }
    }
  },
  "examples": {
    "test_start": {
      "timestamp": "2026-02-11T06:00:00.000Z",
      "trace_id": "bd-144::run-001::001",
      "level": "info",
      "event": "test_start",
      "bead_id": "bd-144",
      "stream": "unit",
      "gate": "structured_log_test",
      "mode": "strict",
      "api_family": "string",
      "symbol": "memcpy"
    },
    "validation_pass": {
      "timestamp": "2026-02-11T06:00:00.005Z",
      "trace_id": "bd-144::run-001::002",
      "level": "info",
      "event": "validation_pass",
      "bead_id": "bd-144",
      "stream": "unit",
      "gate": "structured_log_test",
      "mode": "strict",
      "api_family": "string",
      "symbol": "memcpy",
      "outcome": "pass",
      "latency_ns": 15,
      "details": {
        "input_size": 256,
        "expected_return": 0
      }
    },
    "test_failure": {
      "timestamp": "2026-02-11T06:00:01.000Z",
      "trace_id": "bd-144::run-001::003",
      "level": "error",
      "event": "test_failure",
      "bead_id": "bd-144",
      "stream": "e2e",
      "gate": "e2e_suite",
      "mode": "hardened",
      "api_family": "malloc",
      "symbol": "realloc",
      "decision": "Deny",
      "controller_id": "runtime_math_kernel.v1",
      "decision_action": "Deny",
      "risk_inputs": {
        "requested_bytes": 4096,
        "is_write": true,
        "bloom_negative": true,
        "contention_hint": 4
      },
      "outcome": "fail",
      "errno": 12,
      "details": {
        "expected": "non-null",
        "actual": "null"
      },
      "artifact_refs": [
        "tests/conformance/logs/bd-144-run-001.backtrace"
      ]
    },
    "artifact_index": {
      "index_version": 1,
      "run_id": "run-001",
      "bead_id": "bd-144",
      "generated_utc": "2026-02-11T06:01:00.000Z",
      "artifacts": [
        {
          "path": "tests/conformance/logs/bd-144-run-001.jsonl",
          "kind": "log",
          "sha256": "abc123...",
          "size_bytes": 4096,
          "description": "Structured test log"
        },
        {
          "path": "tests/conformance/golden/fixture_verify_strict_hardened.v1.json",
          "kind": "golden",
          "sha256": "def456...",
          "size_bytes": 18000,
          "description": "Golden conformance verification output"
        }
      ]
    }
  }
}
