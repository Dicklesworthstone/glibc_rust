{
  "schema_version": 1,
  "bead": "bd-wud",
  "description": "Per-API-family behavior table for strict vs hardened mode. Documents how each family responds to violations, invalid inputs, and edge cases under each SafetyLevel.",
  "modes": {
    "strict": {
      "description": "ABI-compatible, POSIX-correct semantics. No healing. Errors match libc behavior. Performance target: <20ns overhead.",
      "heals_enabled": false,
      "env_values": ["strict", "default", "abi"]
    },
    "hardened": {
      "description": "TSM repair mode. Validates AND applies healing. Safety over conformance. Performance target: <200ns overhead.",
      "heals_enabled": true,
      "env_values": ["hardened", "repair", "tsm", "full"]
    }
  },
  "env_variable": "GLIBC_RUST_MODE",
  "families": [
    {
      "family": "Allocator",
      "api_family_enum": "Allocator",
      "module": "malloc_abi",
      "heals_call_sites": 3,
      "symbols": ["malloc", "free", "calloc", "realloc", "posix_memalign", "aligned_alloc", "memalign", "pvalloc", "valloc", "malloc_usable_size"],
      "strict_behavior": {
        "double_free": "Silently ignored (no crash)",
        "foreign_ptr_free": "Silently ignored",
        "realloc_unknown": "Treated as malloc (size unknown)",
        "denial": "Returns NULL, sets errno",
        "overflow": "Canary corruption detected and recorded"
      },
      "hardened_behavior": {
        "double_free": "Ignored + IgnoreDoubleFree healing recorded",
        "foreign_ptr_free": "Ignored + IgnoreForeignFree healing recorded",
        "realloc_unknown": "ReallocAsMalloc healing, calls malloc",
        "denial": "Returns NULL, sets errno (same as strict)",
        "overflow": "Canary corruption detected and recorded (same as strict)"
      }
    },
    {
      "family": "StringMemory",
      "api_family_enum": "StringMemory",
      "module": "string_abi",
      "heals_call_sites": 17,
      "symbols": ["memcpy", "memmove", "memset", "memcmp", "memchr", "strcpy", "strncpy", "strcat", "strncat", "strcmp", "strncmp", "strlen", "strnlen", "strchr", "strrchr", "strstr", "strtok_r", "strerror_r", "strerror"],
      "strict_behavior": {
        "buffer_overflow": "Proceeds (undefined behavior, raw passthrough)",
        "null_pointer": "Deny, returns error/NULL",
        "unbounded_scan": "Raw unbounded scan",
        "copy_overlap": "Proceeds as-is"
      },
      "hardened_behavior": {
        "buffer_overflow": "Truncates to known allocation bounds, records TruncateWithNull/ClampSize",
        "null_pointer": "Deny + ReturnSafeDefault if repairable",
        "unbounded_scan": "Bounded to known allocation extent",
        "copy_overlap": "Bounds-checked, clamped to safe region"
      }
    },
    {
      "family": "WideChar",
      "api_family_enum": "StringMemory",
      "module": "wchar_abi",
      "heals_call_sites": 14,
      "symbols": ["wcslen", "wcscpy", "wcsncpy", "wcscat", "wcsncat", "wcscmp", "wcsncmp", "wcschr", "wcsrchr", "wcsstr", "wmemcpy", "wmemmove", "wmemset", "wmemcmp", "wmemchr", "wcstol", "wcstoul"],
      "strict_behavior": {
        "buffer_overflow": "Proceeds (raw passthrough)",
        "unbounded_scan": "Raw unbounded scan",
        "conversion_overflow": "Returns POSIX-defined limits"
      },
      "hardened_behavior": {
        "buffer_overflow": "Truncates to known bounds via repair_enabled()",
        "unbounded_scan": "Bounded scan within allocation",
        "conversion_overflow": "Clamped to safe values"
      }
    },
    {
      "family": "Stdio",
      "api_family_enum": "Stdio",
      "module": "stdio_abi",
      "heals_call_sites": 2,
      "symbols": ["fopen", "fclose", "fread", "fwrite", "fprintf", "sprintf", "snprintf", "fgets", "fputs", "fflush", "fseek", "ftell", "rewind"],
      "strict_behavior": {
        "invalid_stream": "Returns error/NULL per POSIX",
        "buffer_overflow": "Proceeds as-is"
      },
      "hardened_behavior": {
        "invalid_stream": "Returns safe default + healing recorded",
        "buffer_overflow": "Bounded via repair_enabled(), truncated"
      }
    },
    {
      "family": "Stdlib",
      "api_family_enum": "Stdlib",
      "module": "stdlib_abi",
      "heals_call_sites": 4,
      "symbols": ["atoi", "atol", "atoll", "strtol", "strtoul", "strtoll", "strtoull"],
      "strict_behavior": {
        "unbounded_parse": "Raw unbounded scan of input string",
        "overflow": "Returns LONG_MAX/LONG_MIN per POSIX"
      },
      "hardened_behavior": {
        "unbounded_parse": "Bounded to known allocation via repair_enabled()",
        "overflow": "Same POSIX limits, but scan is bounds-limited"
      }
    },
    {
      "family": "MathFenv",
      "api_family_enum": "MathFenv",
      "module": "math_abi",
      "heals_call_sites": 3,
      "symbols": ["sin", "cos", "tan", "asin", "acos", "atan", "atan2", "exp", "log", "log2", "log10", "pow", "sqrt", "ceil", "floor", "round", "fabs", "fmod", "remainder", "fma"],
      "strict_behavior": {
        "denied": "Returns NaN",
        "non_finite_result": "Returns raw result (NaN/Inf as-is)",
        "domain_error": "Returns NaN (e.g. log(-1))"
      },
      "hardened_behavior": {
        "denied": "Returns 0.0 (safe default)",
        "non_finite_result": "Healed: NaN→0.0, Inf→f64::MAX/MIN",
        "domain_error": "Returns 0.0 via heal_non_finite()"
      }
    },
    {
      "family": "Threading",
      "api_family_enum": "Threading",
      "module": "pthread_abi",
      "heals_call_sites": 2,
      "symbols": ["pthread_create", "pthread_join", "pthread_detach", "pthread_mutex_init", "pthread_mutex_lock", "pthread_mutex_unlock", "pthread_mutex_destroy", "pthread_cond_init", "pthread_cond_wait", "pthread_cond_signal", "pthread_cond_broadcast", "pthread_cond_destroy"],
      "strict_behavior": {
        "EBUSY_destroy": "Returns EBUSY error",
        "EPERM_unlock": "Returns EPERM error"
      },
      "hardened_behavior": {
        "EBUSY_destroy": "Retries/ignores EBUSY, records healing",
        "EPERM_unlock": "Ignores EPERM, records healing"
      }
    },
    {
      "family": "Socket",
      "api_family_enum": "Socket",
      "module": "socket_abi",
      "heals_call_sites": 3,
      "symbols": ["socket", "bind", "listen", "accept", "connect", "send", "recv", "sendto", "recvfrom", "setsockopt", "getsockopt", "shutdown"],
      "strict_behavior": {
        "invalid_domain": "Returns -1, sets EAFNOSUPPORT",
        "invalid_type": "Returns -1, sets EINVAL",
        "sendmsg_overflow": "Proceeds as-is"
      },
      "hardened_behavior": {
        "invalid_domain": "Heals: allows through with healing record",
        "invalid_type": "Heals: allows through with healing record",
        "sendmsg_overflow": "Bounds-checked, clamped"
      }
    },
    {
      "family": "Poll",
      "api_family_enum": "Poll",
      "module": "poll_abi",
      "heals_call_sites": 4,
      "symbols": ["poll", "ppoll", "select", "pselect"],
      "strict_behavior": {
        "invalid_nfds": "Returns -1, sets EINVAL",
        "invalid_select_nfds": "Returns -1, sets EINVAL"
      },
      "hardened_behavior": {
        "invalid_nfds": "Clamps nfds to valid range, records healing",
        "invalid_select_nfds": "Clamps to valid range, records healing"
      }
    },
    {
      "family": "VirtualMemory",
      "api_family_enum": "VirtualMemory",
      "module": "mmap_abi",
      "heals_call_sites": 4,
      "symbols": ["mmap", "munmap", "mprotect", "msync", "madvise", "mremap"],
      "strict_behavior": {
        "invalid_prot": "Returns MAP_FAILED, sets EINVAL",
        "invalid_flags": "Returns error per POSIX",
        "invalid_advice": "Returns -1, sets EINVAL"
      },
      "hardened_behavior": {
        "invalid_prot": "Heals to safe default prot/flags",
        "invalid_flags": "Heals to safe default flags",
        "invalid_advice": "Heals to MADV_NORMAL"
      }
    },
    {
      "family": "IoFd",
      "api_family_enum": "IoFd",
      "module": "io_abi",
      "heals_call_sites": 1,
      "symbols": ["open", "close", "read", "write", "lseek", "dup", "dup2", "pipe", "fcntl", "ioctl"],
      "strict_behavior": {
        "invalid_fd": "Returns -1, sets EBADF",
        "bounds_violation": "Proceeds as-is"
      },
      "hardened_behavior": {
        "invalid_fd": "Returns -1, sets EBADF (same)",
        "bounds_violation": "Applies safe bounds for read/write"
      }
    },
    {
      "family": "Time",
      "api_family_enum": "Time",
      "module": "time_abi",
      "heals_call_sites": 3,
      "symbols": ["time", "gettimeofday", "clock_gettime", "clock_getres", "nanosleep", "clock_nanosleep", "localtime_r", "gmtime_r", "mktime", "strftime"],
      "strict_behavior": {
        "invalid_clock": "Returns -1, sets EINVAL",
        "null_buffer": "Returns error",
        "invalid_timespec": "Proceeds as-is"
      },
      "hardened_behavior": {
        "invalid_clock": "Heals to CLOCK_REALTIME",
        "null_buffer": "Returns safe default",
        "invalid_timespec": "Clamps to valid range"
      }
    },
    {
      "family": "Termios",
      "api_family_enum": "Termios",
      "module": "termios_abi",
      "heals_call_sites": 3,
      "symbols": ["tcgetattr", "tcsetattr", "tcsendbreak", "tcdrain", "tcflush", "tcflow", "cfgetispeed", "cfgetospeed", "cfsetispeed", "cfsetospeed"],
      "strict_behavior": {
        "invalid_action": "Returns -1, sets EINVAL",
        "invalid_queue": "Returns -1, sets EINVAL",
        "invalid_flow": "Returns -1, sets EINVAL"
      },
      "hardened_behavior": {
        "invalid_action": "Heals to TCSANOW",
        "invalid_queue": "Heals to TCIFLUSH",
        "invalid_flow": "Heals to TCION"
      }
    },
    {
      "family": "Loader",
      "api_family_enum": "Loader",
      "module": "dlfcn_abi",
      "heals_call_sites": 1,
      "symbols": ["dlopen", "dlclose", "dlsym", "dlerror"],
      "strict_behavior": {
        "invalid_flags": "Returns NULL, sets dlerror"
      },
      "hardened_behavior": {
        "invalid_flags": "Heals to RTLD_LAZY | RTLD_LOCAL"
      }
    },
    {
      "family": "Dirent",
      "api_family_enum": "IoFd",
      "module": "dirent_abi",
      "heals_call_sites": 3,
      "symbols": ["opendir", "readdir", "readdir_r", "closedir", "rewinddir", "seekdir", "telldir"],
      "strict_behavior": {
        "null_dir": "Returns NULL/error",
        "invalid_loc": "Proceeds as-is",
        "readdir_null": "Returns NULL"
      },
      "hardened_behavior": {
        "null_dir": "Returns NULL + safe default",
        "invalid_loc": "Clamps/ignores invalid seek locations",
        "readdir_null": "Returns NULL (same, but bounds-checked)"
      }
    },
    {
      "family": "Resource",
      "api_family_enum": "Stdlib",
      "module": "resource_abi",
      "heals_call_sites": 1,
      "symbols": ["getrlimit", "setrlimit", "getrusage"],
      "strict_behavior": {
        "invalid_limit": "Returns -1, sets EINVAL"
      },
      "hardened_behavior": {
        "invalid_limit": "Clamps rlim values to safe defaults"
      }
    },
    {
      "family": "Process",
      "api_family_enum": "Process",
      "module": "process_abi",
      "heals_call_sites": 2,
      "symbols": ["fork", "execve", "execvp", "waitpid", "wait", "_exit", "getpid", "getppid"],
      "strict_behavior": {
        "invalid_envp": "Proceeds as-is (raw passthrough)",
        "invalid_wait_options": "Returns -1, sets EINVAL"
      },
      "hardened_behavior": {
        "invalid_envp": "Clamps envp scan to safe bounds",
        "invalid_wait_options": "Heals to valid options subset"
      }
    },
    {
      "family": "Locale",
      "api_family_enum": "Locale",
      "module": "locale_abi",
      "heals_call_sites": 1,
      "symbols": ["setlocale", "localeconv"],
      "strict_behavior": {
        "invalid_category": "Returns NULL"
      },
      "hardened_behavior": {
        "invalid_category": "Returns C locale as safe fallback"
      }
    },
    {
      "family": "Resolver",
      "api_family_enum": "Resolver",
      "module": "resolv_abi",
      "heals_call_sites": 2,
      "symbols": ["getaddrinfo", "freeaddrinfo", "getnameinfo", "gai_strerror"],
      "strict_behavior": {
        "invalid_hints": "Returns EAI_BADFLAGS/EAI_FAMILY",
        "buffer_overflow": "Proceeds as-is"
      },
      "hardened_behavior": {
        "invalid_hints": "Heals via repair_enabled(), safe defaults",
        "buffer_overflow": "Bounded output via repair_enabled()"
      }
    },
    {
      "family": "Unistd",
      "api_family_enum": "IoFd",
      "module": "unistd_abi",
      "heals_call_sites": 4,
      "symbols": ["access", "getcwd", "chdir", "chown", "fchown", "link", "unlink", "rmdir", "symlink", "readlink", "truncate", "ftruncate", "sysconf", "pathconf", "fpathconf", "getuid", "geteuid", "getgid", "getegid"],
      "strict_behavior": {
        "buffer_overflow": "Proceeds as-is",
        "invalid_path": "Returns -1, sets errno",
        "null_buffer": "Returns -1, sets EFAULT"
      },
      "hardened_behavior": {
        "buffer_overflow": "Bounded via repair_enabled()",
        "invalid_path": "Returns -1 (same) + healing record",
        "null_buffer": "Returns safe default"
      }
    }
  ],
  "summary": {
    "total_families": 20,
    "families_with_healing": 20,
    "total_heals_call_sites": 77,
    "healing_actions": [
      "ClampSize",
      "TruncateWithNull",
      "IgnoreDoubleFree",
      "IgnoreForeignFree",
      "ReallocAsMalloc",
      "ReturnSafeDefault",
      "UpgradeToSafeVariant",
      "None"
    ],
    "common_patterns": {
      "repair_enabled": "heals_enabled || matches!(action, MembraneAction::Repair(_))",
      "bounds_clamping": "known_remaining() used to limit scan/copy extent",
      "safe_default": "Returns 0/0.0/NULL/C-locale instead of UB"
    }
  }
}
