{
  "schema_version": 1,
  "bead": "bd-2wp",
  "description": "Perf baseline suite specification: canonical benchmark commands, percentile capture targets, baseline regeneration procedures, and regression detection thresholds for strict/hardened critical paths.",
  "benchmark_suites": {
    "description": "Canonical benchmark suites organized by subsystem. Each suite defines commands, expected output format, and percentile capture targets.",
    "suites": [
      {
        "id": "runtime_math",
        "description": "RuntimeMathKernel decision and observation overhead.",
        "crate": "glibc-rs-bench",
        "command": "cargo bench -p glibc-rs-bench --bench runtime_math_bench",
        "output_prefix": "RUNTIME_MATH_BENCH",
        "benchmarks": [
          {"name": "decide", "description": "Per-call overhead of RuntimeMathKernel::decide()"},
          {"name": "observe_fast", "description": "Per-call overhead of observe_validation_result()"},
          {"name": "decide_observe", "description": "Combined decide + observe hot path"}
        ],
        "modes": ["strict", "hardened"],
        "env_vars": {
          "GLIBC_RUST_MODE": "<mode>",
          "GLIBC_RUST_BENCH_PIN": "1"
        },
        "criterion_config": {
          "sample_size": 100,
          "measurement_time_secs": 2,
          "warm_up_time_ms": 1
        },
        "enforced_in_gate": true
      },
      {
        "id": "membrane",
        "description": "Pointer validation pipeline overhead per stage.",
        "crate": "glibc-rs-bench",
        "command": "cargo bench -p glibc-rs-bench --bench membrane_bench",
        "output_prefix": "MEMBRANE_BENCH",
        "benchmarks": [
          {"name": "validate_known", "description": "Hot-path validation for known-safe pointers"}
        ],
        "modes": ["strict", "hardened"],
        "env_vars": {
          "GLIBC_RUST_MODE": "<mode>",
          "GLIBC_RUST_BENCH_PIN": "1"
        },
        "criterion_config": {
          "sample_size": 100,
          "measurement_time_secs": 2,
          "warm_up_time_ms": 1
        },
        "enforced_in_gate": true
      },
      {
        "id": "string",
        "description": "String/memory function benchmarks across size variants.",
        "crate": "glibc-rs-bench",
        "command": "cargo bench -p glibc-rs-bench --bench string_bench",
        "output_prefix": "STRING_BENCH",
        "benchmarks": [
          {"name": "memcpy_16", "description": "memcpy 16 bytes"},
          {"name": "memcpy_64", "description": "memcpy 64 bytes"},
          {"name": "memcpy_256", "description": "memcpy 256 bytes"},
          {"name": "memcpy_1024", "description": "memcpy 1KB"},
          {"name": "memcpy_4096", "description": "memcpy 4KB"},
          {"name": "memcpy_65536", "description": "memcpy 64KB"},
          {"name": "strlen_16", "description": "strlen 16-char string"},
          {"name": "strlen_256", "description": "strlen 256-char string"}
        ],
        "modes": ["strict", "hardened"],
        "env_vars": {
          "GLIBC_RUST_MODE": "<mode>",
          "GLIBC_RUST_BENCH_PIN": "1"
        },
        "criterion_config": {
          "sample_size": 100,
          "measurement_time_secs": 2,
          "warm_up_time_ms": 1
        },
        "enforced_in_gate": false,
        "enforcement_note": "Exists but not yet wired to perf_gate.sh. See waiver bd-242."
      },
      {
        "id": "malloc",
        "description": "Allocator hot-path benchmarks.",
        "crate": "glibc-rs-bench",
        "command": "cargo bench -p glibc-rs-bench --bench malloc_bench",
        "output_prefix": "MALLOC_BENCH",
        "benchmarks": [
          {"name": "alloc_free_cycle", "description": "Single malloc+free cycle"},
          {"name": "alloc_burst", "description": "Burst allocation pattern"}
        ],
        "modes": ["strict", "hardened"],
        "env_vars": {
          "GLIBC_RUST_MODE": "<mode>",
          "GLIBC_RUST_BENCH_PIN": "1"
        },
        "criterion_config": {
          "sample_size": 100,
          "measurement_time_secs": 2,
          "warm_up_time_ms": 1
        },
        "enforced_in_gate": false,
        "enforcement_note": "Exists but not yet wired to perf_gate.sh. See waiver bd-242."
      }
    ]
  },
  "percentile_targets": {
    "description": "Baseline snapshots capture multiple percentiles for regression analysis. p50 is the primary gate metric; p95/p99 are tracked for tail-latency visibility.",
    "captured_percentiles": ["p50", "p95", "p99"],
    "primary_gate_metric": "p50",
    "secondary_metrics": ["p95", "p99"],
    "gate_behavior": {
      "p50": "Regression beyond max_regression_pct fails the gate.",
      "p95": "Regression reported as warning. Does not fail gate (informational).",
      "p99": "Regression reported as warning. Does not fail gate (informational)."
    }
  },
  "baseline_format": {
    "description": "Schema for perf_baseline.json: the machine-specific baseline file used by perf_gate.sh.",
    "file": "scripts/perf_baseline.json",
    "required_fields": {
      "version": "Integer, monotonically increasing on each regeneration.",
      "generated_at_utc": "ISO-8601 timestamp of baseline capture.",
      "targets_ns_op": "Per-mode target budgets (from perf_budget_policy.json).",
      "baseline_p50_ns_op": "Per-suite, per-mode, per-benchmark p50 in nanoseconds/operation."
    },
    "planned_fields": {
      "baseline_p95_ns_op": "Per-suite, per-mode, per-benchmark p95 (not yet captured).",
      "baseline_p99_ns_op": "Per-suite, per-mode, per-benchmark p99 (not yet captured).",
      "machine_fingerprint": "CPU model, core count, kernel version for reproducibility audit.",
      "criterion_raw_ref": "Path to Criterion raw JSON for offline re-analysis."
    },
    "current_suites_in_baseline": ["runtime_math", "membrane"],
    "planned_suites": ["string", "malloc"]
  },
  "regeneration": {
    "description": "Procedure for regenerating baselines deterministically.",
    "prerequisites": [
      "Machine is not under heavy load (load < 0.85 * nproc).",
      "CPU pinning enabled: GLIBC_RUST_BENCH_PIN=1.",
      "No other benchmark or CI tasks running.",
      "All workspace changes committed (clean git state)."
    ],
    "command_sequence": [
      "export GLIBC_RUST_BENCH_PIN=1",
      "cargo bench -p glibc-rs-bench --bench runtime_math_bench 2>&1 | tee /tmp/bench_runtime_math.txt",
      "cargo bench -p glibc-rs-bench --bench membrane_bench 2>&1 | tee /tmp/bench_membrane.txt",
      "cargo bench -p glibc-rs-bench --bench string_bench 2>&1 | tee /tmp/bench_string.txt",
      "cargo bench -p glibc-rs-bench --bench malloc_bench 2>&1 | tee /tmp/bench_malloc.txt"
    ],
    "extraction": "Parse RUNTIME_MATH_BENCH/MEMBRANE_BENCH/STRING_BENCH/MALLOC_BENCH lines for p50_ns_op values.",
    "validation": {
      "min_repeat_runs": 3,
      "max_cv_pct": 15,
      "outlier_policy": "Drop highest and lowest of N>=3 runs, use median of remaining."
    },
    "update_policy": "Manual update only. New baselines require review comment explaining the improvement source or measurement environment change."
  },
  "regression_detection": {
    "description": "How perf_gate.sh detects regressions against the baseline.",
    "algorithm": "current_p50 <= baseline_p50 * (1 + max_regression_pct / 100)",
    "max_regression_pct": 15,
    "target_violation_check": "current_p50 <= target_ns_op (strict: 20ns, hardened: 200ns). Currently waived under bd-242.",
    "load_guard": {
      "enabled": true,
      "max_load_factor": 0.85,
      "behavior": "Skip perf gate with warning on overloaded machines."
    },
    "output_on_regression": {
      "reported_fields": ["suite", "benchmark", "mode", "baseline_p50_ns", "current_p50_ns", "regression_pct", "target_ns", "verdict"],
      "exit_code": 1
    }
  },
  "cross_references": {
    "perf_budget_policy": "tests/conformance/perf_budget_policy.json",
    "perf_baseline": "scripts/perf_baseline.json",
    "perf_gate": "scripts/perf_gate.sh",
    "check_perf_budget": "scripts/check_perf_budget.sh",
    "bench_compare": "scripts/bench_compare.sh",
    "profile_pipeline": "scripts/profile_pipeline.sh",
    "support_matrix": "support_matrix.json",
    "waiver_bead": "bd-242"
  },
  "summary": {
    "total_suites": 4,
    "total_benchmarks": 14,
    "enforced_suites": 2,
    "planned_suites": 2,
    "modes": 2,
    "captured_percentiles": 3,
    "regeneration_steps": 5,
    "prerequisite_checks": 4
  }
}
